<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estimate For Civil/Electrical and Other Engineering Works</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Libraries for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <style>
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .current-context { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .report-output { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .report-table th, .report-table td { border: 1px solid #dee2e6; padding: 0.75rem; text-align: center; }
        .report-table th { background-color: #e9ecef; }
        .building-group { margin-bottom: 30px; }
        .building-header { background-color: #e9ecef; padding: 10px; font-weight: bold; }
        .current-item-desc { color: #6c757d; font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 0.5rem; }
        .measurement-section { margin-bottom: 30px; }
        .records-section { margin-top: 30px; }
        .filter-section { background-color: #f0f5ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .report-title { text-align: center; margin-bottom: 20px; }
        .report-subtitle { text-align: center; margin-bottom: 30px; }
        .data-import-export { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 5px; }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Estimate For Civil/Electrical and Other Engineering Works</h1>
        <p class="text-center text-muted">Building wise Abstract and Cumulative Abstract reports</p>

        <div class="row mb-3">
            <div class="col-md-12 text-right">
                <span class="badge badge-primary p-2">Administrator</span>
                <button class="btn btn-outline-secondary btn-sm">Logout</button>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>Instructions:</strong> Add projects, buildings, and items first. Then set your context and enter multiple measurements without reselecting.
        </div>

        <nav class="nav nav-tabs" id="mainTabs">
            <a class="nav-link active" href="#" data-target="projects">Projects</a>
            <a class="nav-link" href="#" data-target="buildings">Buildings</a>
            <a class="nav-link" href="#" data-target="items">Items</a>
            <a class="nav-link" href="#" data-target="measurements">Measurements</a>
            <a class="nav-link" href="#" data-target="reports">Reports</a>
        </nav>

        <!-- Project Management Section -->
        <div id="projects" class="tab-pane active">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">Project Management</div>
                <div class="card-body">
                    <form id="projectForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Project Name</label>
                                <input type="text" class="form-control" id="projectName">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Project Code</label>
                                <input type="text" class="form-control" id="projectCode">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Location</label>
                                <input type="text" class="form-control" id="projectLocation">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Description</label>
                                <input type="text" class="form-control" id="projectDescription">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addProject">Add Project</button>
                        <button type="button" class="btn btn-success" id="updateProject" style="display:none;">Update Project</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditProject" style="display:none;">Cancel</button>
                    </form>
                    <h5 class="mt-4">Project List</h5>
                    <table class="table table-bordered" id="projectList">
                        <thead class="thead-light">
                            <tr>
                                <th>Project Code</th>
                                <th>Project Name</th>
                                <th>Location</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <!-- Data Import/Export Section -->
                    <div class="data-import-export">
                        <h5>Data Transfer</h5>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <button type="button" class="btn btn-info btn-block" id="exportProjects">Export Projects</button>
                            </div>
                            <div class="form-group col-md-6">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="importProjectsFile" accept=".json,.xlsx">
                                    <label class="custom-file-label" for="importProjectsFile">Choose file</label>
                                </div>
                                <button type="button" class="btn btn-warning btn-block mt-2" id="importProjects">Import Projects</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Building Management Section -->
        <div id="buildings" class="tab-pane">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">Building Management</div>
                <div class="card-body">
                    <form id="buildingForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Select Project</label>
                                <select class="form-control" id="selectProjectBuilding"></select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Building Name</label>
                                <input type="text" class="form-control" id="buildingName">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Building Type</label>
                                <select class="form-control" id="buildingType">
                                    <option>-- Select Type --</option>
                                    <option>Residential</option>
                                    <option>Commercial</option>
                                    <option>Institutional</option>
                                    <option>Industrial</option>
                                    <option>Infrastructure</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Number of Floors</label>
                                <input type="number" class="form-control" id="numFloors">
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addBuilding">Add Building</button>
                        <button type="button" class="btn btn-success" id="updateBuilding" style="display:none;">Update Building</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBuilding" style="display:none;">Cancel</button>
                    </form>
                    <h5 class="mt-4">Building List</h5>
                    <table class="table table-bordered" id="buildingList">
                        <thead class="thead-light">
                            <tr>
                                <th>Project</th>
                                <th>Building Name</th>
                                <th>Type</th>
                                <th>Floors</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <!-- Data Import/Export Section -->
                    <div class="data-import-export">
                        <h5>Data Transfer</h5>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <button type="button" class="btn btn-info btn-block" id="exportBuildings">Export Buildings</button>
                            </div>
                            <div class="form-group col-md-6">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="importBuildingsFile" accept=".json,.xlsx">
                                    <label class="custom-file-label" for="importBuildingsFile">Choose file</label>
                                </div>
                                <button type="button" class="btn btn-warning btn-block mt-2" id="importBuildings">Import Buildings</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Management Section -->
        <div id="items" class="tab-pane">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">Item Management</div>
                <div class="card-body">
                    <form id="itemForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Item Code (CPWD)</label>
                                <input type="text" class="form-control" id="itemCode">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Item Description</label>
                                <input type="text" class="form-control" id="itemDescription">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Short Description</label>
                                <input type="text" class="form-control" id="shortDescription">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Unit</label>
                                <select class="form-control" id="unit">
                                    <option value="cum">Cubic Meter (Cum)</option>
                                    <option value="sqm">Square Meter (Sqm)</option>
                                    <option value="m">Meter</option>
                                    <option value="kg">Kilogram (Kg)</option>
                                    <option value="no">Numbers (Nos)</option>
                                    <option value="lumsum">Lumsum (Lumsum)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Rate (₹ per unit)</label>
                                <input type="number" class="form-control" id="rate">
                            </div>
                            <div class="form-group col-md-6">
                                <label>Category</label>
                                <select class="form-control" id="category">
                                    <option>Earthwork</option>
                                    <option>Concrete</option>
                                    <option>Masonry</option>
                                    <option>Finishing</option>
                                    <option>Structural</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" id="addItem">Add Item</button>
                        <button type="button" class="btn btn-success" id="updateItem" style="display:none;">Update Item</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditItem" style="display:none;">Cancel</button>
                    </form>
                    <h5 class="mt-4">Item List</h5>
                    <table class="table table-bordered" id="itemList">
                        <thead class="thead-light">
                            <tr>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Short Desc</th>
                                <th>Unit</th>
                                <th>Rate (₹)</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    
                    <!-- Data Import/Export Section -->
                    <div class="data-import-export">
                        <h5>Data Transfer</h5>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <button type="button" class="btn btn-info btn-block" id="exportItems">Export Items</button>
                            </div>
                            <div class="form-group col-md-6">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="importItemsFile" accept=".json,.xlsx">
                                    <label class="custom-file-label" for="importItemsFile">Choose file</label>
                                </div>
                                <button type="button" class="btn btn-warning btn-block mt-2" id="importItems">Import Items</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Measurement Entry and Records Section -->
        <div id="measurements" class="tab-pane">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">Measurement Entry</div>
                <div class="card-body">
                    <div class="current-context">
                        <p class="current-project">Project: Not set</p>
                        <p class="current-building">Building: Not set</p>
                        <div>
                            <p class="current-item mb-0">Item: Not set</p>
                            <p class="current-item-desc">-</p>
                        </div>
                        <p class="current-unit">Unit: -</p>
                        <p class="current-rate">Rate: -</p>
                    </div>
                    <form>
                        <div class="form-group">
                            <label>Select Project</label>
                            <select id="projectSelect" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Select Building</label>
                            <select id="buildingSelect" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Select Item</label>
                            <select id="itemSelect" class="form-control"></select>
                        </div>
                        <button type="button" id="setContext" class="btn btn-primary">Set Context</button>
                    </form>
                    <div class="measurement-section">
                        <h5 class="mt-4">Measurement Sheet</h5>
                        <p id="quantityFormula">Quantity Calculation Formula: Qty = No1 × No2 × No3 × Length × Width × Height</p>
                        <table id="measurementTable" class="table table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>Location</th>
                                    <th>No1</th>
                                    <th>No2</th>
                                    <th>No3</th>
                                    <th>Length</th>
                                    <th>Width</th>
                                    <th>Height</th>
                                    <th>Qty</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="measurementBody"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="7">Total</td>
                                    <td id="totalQty">0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button id="addRow" class="btn btn-primary">Add Row</button>
                        <button id="saveMeasurements" class="btn btn-success">Save Measurements</button>
                        <button id="resetSheet" class="btn btn-danger">Reset Sheet</button>
                    </div>
                    
                    <!-- Measurement Records Section -->
                    <div class="records-section">
                        <h5 class="mt-5">Measurement Records</h5>
                        <div class="filter-section">
                            <h6>Filter Records</h6>
                            <form class="form-inline">
                                <div class="form-group mr-2 mb-2">
                                    <label class="mr-2">Project</label>
                                    <select class="form-control" id="filterProject">
                                        <option value="">All Projects</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2 mb-2">
                                    <label class="mr-2">Building</label>
                                    <select class="form-control" id="filterBuilding">
                                        <option value="">All Buildings</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2 mb-2">
                                    <label class="mr-2">Item</label>
                                    <select class="form-control" id="filterItem">
                                        <option value="">All Items</option>
                                    </select>
                                </div>
                                <div class="form-group mr-2 mb-2">
                                    <label class="mr-2">Location</label>
                                    <input type="text" class="form-control" id="filterLocation" placeholder="Location">
                                </div>
                                <button type="button" id="applyFilters" class="btn btn-primary mr-2 mb-2">Apply Filters</button>
                                <button type="button" id="resetFilters" class="btn btn-secondary mb-2">Reset</button>
                            </form>
                        </div>
                        <table id="recordsTable" class="table table-bordered mt-3">
                            <thead class="thead-light">
                                <tr>
                                    <th>Project</th>
                                    <th>Building</th>
                                    <th>Item Code</th>
                                    <th>Short Desc</th>
                                    <th>Location</th>
                                    <th>No1</th>
                                    <th>No2</th>
                                    <th>No3</th>
                                    <th>Length</th>
                                    <th>Width</th>
                                    <th>Height</th>
                                    <th>Qty</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recordsBody"></tbody>
                        </table>
                        
                        <!-- Data Import/Export Section -->
                        <div class="data-import-export">
                            <h5>Data Transfer</h5>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <button type="button" class="btn btn-info btn-block" id="exportMeasurements">Export Measurements</button>
                                </div>
                                <div class="form-group col-md-6">
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="importMeasurementsFile" accept=".json,.xlsx">
                                        <label class="custom-file-label" for="importMeasurementsFile">Choose file</label>
                                    </div>
                                    <button type="button" class="btn btn-warning btn-block mt-2" id="importMeasurements">Import Measurements</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="tab-pane">
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">Generate Reports</div>
                <div class="card-body">
                    <form id="reportForm">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select class="form-control" id="reportType">
                                <option value="building-wise">Building-wise Abstract</option>
                                <option value="project-details">Project Details Abstract</option>
                                <option value="project-cumulative">Project Cumulative Abstract</option>
                                <option value="detailed-measurement">Detailed Measurement Sheet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Select Project</label>
                            <select class="form-control" id="reportProject"></select>
                        </div>
                        <button type="button" id="generateReport" class="btn btn-primary">Generate Report</button>
                    </form>
                    <div class="report-output mt-3" id="reportOutput"></div>
                    <div class="mt-3">
                        <button class="btn btn-secondary" id="exportExcel">Export to Excel</button>
                        <button class="btn btn-secondary" id="exportPDF">Export to PDF</button>
                        <button class="btn btn-secondary" id="printReport">Print Report</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-5 py-3 bg-light">
            © 2023 Estimate For Civil/Electrical and Other Engineering Works | Designed for Engineering Professionals
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgv0gKYbJKaREhM8_W36iSDsUJiUvYW68",
            authDomain: "estimate-tool-a1e4c.firebaseapp.com",
            databaseURL: "https://estimate-tool-a1e4c-default-rtdb.firebaseio.com",
            projectId: "estimate-tool-a1e4c",
            storageBucket: "estimate-tool-a1e4c.appspot.com",
            messagingSenderId: "290014727521",
            appId: "1:290014727521:web:93f2f96d54767e73cb8920",
            measurementId: "G-S1GCNGWBH3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Data storage using localStorage with Firebase sync
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let buildings = JSON.parse(localStorage.getItem('buildings')) || [];
        let items = JSON.parse(localStorage.getItem('items')) || [];
        let measurements = JSON.parse(localStorage.getItem('measurements')) || [];

        let currentEditIndex = null;
        let currentProject = 'Not set';
        let currentBuilding = 'Not set';
        let currentItem = 'Not set';
        let currentItemDesc = '';
        let currentUnit = '-';
        let currentRate = '-';
        let filteredMeasurements = [];

        // Function to save data to localStorage and Firebase
        function saveData(key, data) {
            // Save to localStorage
            localStorage.setItem(key, JSON.stringify(data));
            
            // Prepare all data for Firebase
            const allData = {
                projects: JSON.parse(localStorage.getItem('projects')) || [],
                buildings: JSON.parse(localStorage.getItem('buildings')) || [],
                items: JSON.parse(localStorage.getItem('items')) || [],
                measurements: JSON.parse(localStorage.getItem('measurements')) || []
            };
            
            // Save to Firebase
            firebase.database().ref('estimateData').set(allData)
                .catch(error => {
                    console.error('Error saving to Firebase:', error);
                });
        }

        // Load data from Firebase when page loads
        function loadFromFirebase() {
            firebase.database().ref('estimateData').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        projects = data.projects || [];
                        buildings = data.buildings || [];
                        items = data.items || [];
                        measurements = data.measurements || [];
                        
                        // Update localStorage
                        localStorage.setItem('projects', JSON.stringify(projects));
                        localStorage.setItem('buildings', JSON.stringify(buildings));
                        localStorage.setItem('items', JSON.stringify(items));
                        localStorage.setItem('measurements', JSON.stringify(measurements));
                        
                        // Update UI
                        loadProjectList();
                        loadBuildingList();
                        loadItemList();
                        loadRecords();
                    }
                })
                .catch(error => {
                    console.error('Error loading from Firebase:', error);
                });
        }

        // Set up real-time listener for data changes
        function setupRealtimeListener() {
            firebase.database().ref('estimateData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    projects = data.projects || [];
                    buildings = data.buildings || [];
                    items = data.items || [];
                    measurements = data.measurements || [];
                    
                    // Update localStorage
                    localStorage.setItem('projects', JSON.stringify(projects));
                    localStorage.setItem('buildings', JSON.stringify(buildings));
                    localStorage.setItem('items', JSON.stringify(items));
                    localStorage.setItem('measurements', JSON.stringify(measurements));
                    
                    // Update UI
                    loadProjectList();
                    loadBuildingList();
                    loadItemList();
                    loadRecords();
                }
            });
        }

        // Tab functionality
        document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const target = this.getAttribute('data-target');
                
                // Remove active class from all tabs
                document.querySelectorAll('#mainTabs .nav-link').forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab panes
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                // Show target pane
                document.getElementById(target).classList.add('active');
            });
        });

        // [Rest of your existing JavaScript code remains exactly the same...]
        // All your existing functions (loadProjectList, loadBuildingList, etc.) should remain unchanged
        // Only the Firebase integration parts have been modified

        // Initial loads
        loadFromFirebase();
        setupRealtimeListener();
    </script>
</body>
</html>